<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Narratives & Legitimacy Citation Graph</title>
<style>
  body { font-family: Arial, sans-serif; }
  .node circle { stroke: #fff; stroke-width: 1.5px; }
  .link { stroke: #999; stroke-opacity: 0.6; }
  .tooltip {
    position: absolute;
    text-align: left;
    width: 260px;
    padding: 8px;
    font-size: 13px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    pointer-events: none;
  }
  .legend { position: absolute; left: 10px; top: 10px; background:#fff; padding:8px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1)}
</style>
</head>
<body>
<h2>Narratives & Legitimacy â€” Prototype Citation Graph (interactive)</h2>
<div class="legend"><strong>Legend</strong><br>Double-click nodes to open source. Drag to rearrange. Hover links to see mechanism.</div>
<svg width="1000" height="700"></svg>
<div id="tooltip" class="tooltip" style="display:none;"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
fetch('narrative_graph_data.json').then(r=>r.json()).then(function(graph){
  const svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

  const simulation = d3.forceSimulation(graph.nodes)
      .force("link", d3.forceLink(graph.links).id(d => d.id).distance(160).strength(0.6))
      .force("charge", d3.forceManyBody().strength(-350))
      .force("center", d3.forceCenter(width / 2, height / 2));

  const link = svg.append("g")
      .attr("class", "links")
    .selectAll("line")
    .data(graph.links)
    .enter().append("line")
      .attr("stroke-width", 2)
      .on("mouseover", function(event,d){
         const tt = document.getElementById('tooltip'); tt.style.display='block';
         tt.innerHTML = '<strong>Mechanism:</strong> ' + d.mechanism;
      })
      .on("mousemove", function(event){
         const tt = document.getElementById('tooltip'); tt.style.left=(event.pageX+12)+'px'; tt.style.top=(event.pageY+12)+'px';
      })
      .on("mouseout", function(){ document.getElementById('tooltip').style.display='none'; });

  const node = svg.append("g")
      .attr("class", "nodes")
    .selectAll("g")
    .data(graph.nodes)
    .enter().append("g")
      .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

  node.append("circle")
      .attr("r", 18)
      .attr("fill", d => d.group === 'classic' ? '#1f77b4' : '#ff7f0e')
      .on("dblclick", (event,d) => window.open(d.url, '_blank'));

  node.append("text")
      .attr("x", 22)
      .attr("y", 5)
      .text(d => d.title)
      .style("font-size","11px");

  simulation.on("tick", () => {
    link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

    node.attr("transform", d => 'translate(' + d.x + ',' + d.y + ')');
  });

  function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
  }

  function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
});
</script>
</body>
</html>
